- [3.1. Проектирование схемы БД](#проектирование-схемы-бд)
- [3.2. Репликация, Партиционирование, Шардирование...](#hw-32-репликация-партиционирование-шардирование-хосты)

## Проектирование схемы БД

### [Интерактивный просмотр схемы базы данных](https://dbdiagram.io/d/Social-Network-68d6ae16d2b621e422171c3c)

![alt text](scheme.png)

### Прогноз количества дисков для хранения и обработки представленных данных на 1 год:

- [Расчеты RPS/Трафика](https://github.com/zkryaev/social_network_system_design/tree/develop#:~:text=%D0%BA%D0%BE%D0%BC%D0%BC%D0%B5%D0%BD%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F/%D0%BF%D0%BE%D0%B4%D0%BF%D0%B8%D1%81%D0%BA%D0%B8%3A%201%D1%81-,%D0%9E%D1%86%D0%B5%D0%BD%D0%BA%D0%B0%20%D0%BD%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B8,-%D0%A0%D0%B0%D1%81%D1%87%D0%B5%D1%82%20RPS)

#### Расчет характеристик по доменам
| Домен         | Объем хранимого    | Throughput | IOPS    |
|---------------|--------------------|------------|---------|
| Посты         | 3,2 Tb             | 70 Mb/s    | ~3600   |
| Комментарии   | 16 Tb              | 13 Mb/s    | ~1700   |
| Лайки         | 2,2 Tb             | 98 Kb/s    | ~5300   |
| Подписка      | 22 Gb              | 61 Kb/s    | ~600    |
| Профиль       | 31 Mb              | 12 Mb/s    | ~600    |
| Поиск         | —                  | 139 Kb/s   | ~600    |
| Медиа         | 24 Pb (~24 000 Tb) | 53 Gb/s    | ~3600   |


#### Расчет числа HDD по доменам
| Домен         | Объем хранимого | Throughput | IOPS |
|---------------|-----------------|------------|------|
| Посты         | 1               | 1          | 36   |
| Комментарии   | 1               | 1          | 17   |
| Лайки         | 1               | 1          | 53   |
| Подписка      | 1               | 1          | 6    |
| Профиль       | 1               | 1          | 6    |
| Поиск         | —               | 1          | 6    |
| Медиа         | 750             | 530        | 36   |

- Чтобы хранить и обрабатывать в том числе изображения нужно 750 дисков типа HDD
- Если опираться, что средняя цена 6ТБ HDD = 100$, то 750\*(32/6)\*100$ ~ 400k$  

#### Расчет числа SSD по доменам
| Домен         | Объем хранимого | Throughput | IOPS |
|---------------|-----------------|------------|------|
| Посты         | 1               | 1          | 4    |
| Комментарии   | 1               | 1          | 2    |
| Лайки         | 1               | 1          | 6    |
| Подписка      | 1               | 1          | 1    |
| Профиль       | 1               | 1          | 1    |
| Поиск         | —               | 1          | 1    |
| Медиа         | 240             | 106        | 4    |

- Чтобы хранить и обрабатывать в том числе изображения нужно 240 дисков типа SSD
- Если опираться, что средняя цена 6ТБ SSD = 200$, то 240\*(100/6)\*200$ ~ 800k$

#### Расчет числа nVME по доменам
| Домен         | Объем хранимого | Throughput | IOPS |
|---------------|-----------------|------------|------|
| Посты         | 1               | 1          | 1    |
| Комментарии   | 1               | 1          | 1    |
| Лайки         | 1               | 1          | 1    |
| Подписка      | 1               | 1          | 1    |
| Профиль       | 1               | 1          | 1    |
| Поиск         | —               | 1          | 1    |
| Медиа         | 800             | 18         | 1    |

- Чтобы хранить и обрабатывать в том числе изображения нужно 800 дисков типа nVME
- Если опираться, что средняя цена 6ТБ nVME = 500$, то 800\*(30/6)\*500$ ~ 2kk$ 

Вывод:
- В рамках расчетов я бы взял 1 SSD для всех доменов кроме Медиа - его бы хватило на несколько лет.
  
  Медиа держал бы на 750 HDD (какой нибудь Blob Storage развернуть на RAID массивах)

  Таким образом быстро бы грузили ленту, обновляли данные, но с изображениями пришлось бы подождать

- Кроме того, можно подумать о сжатии, правда почти всегда это потери в качестве изображения.


## HW-3.2: Репликация, партиционирование, шардирование, хосты

### Репликация

#### Стратегия репликации: **Master-Slave**

#### Replication Factor: **3**
На мастер приходится 2 реплики: SYNC (HOT-STANDBY, чтение) и ASYNC (Для чтения, сбора аналитики).

#### Способ репликации: **Логический - MIXED**

---

### Шардирование/Партиционирование: **Directory Based**
Кажется, что достаточно завести партиции по geo_tag_id для постов и пользователей и всех связанных с ними сущностей, разбить по странам и регионам. 
Быстрый рост можно ожидать в количестве, постов, комментариев - их также можно разбить по Key Based.
 
Также можно параллельно с этим вести партиции по времени создания поста, тем самым таблички со старыми постами можно переводить на HDD, поскольку кол-во обращений к ним условно спустя месяц будет очень маленьким

### Вычисление кол-ва хостов
Если считать без медиа, то:
1. HDD:
- Hosts = 36/2 = 18
- Hosts_with_replication = 54
2. SSD:
- Hosts = 1
- Hosts_WR = 3
3. nVME:
- Hosts = 1
- Hosts_WR = 3

Если с медиа...:
1. HDD:
- Hosts = 750/2 = 375
- Hosts_with_replication = 1125
2. SSD:
- Hosts = 240/2 = 120
- Hosts_WR = 360
3. nVME:
- Hosts = 800/2 = 400
- Hosts_WR = 1200