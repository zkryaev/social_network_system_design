- [3.1. Проектирование схемы БД](#проектирование-схемы-бд)
- [3.2. Репликация, Партиционирование, Шардирование...](#hw-32-репликация-партиционирование-шардирование-хосты)

## Проектирование схемы БД

### [Интерактивный просмотр схемы базы данных](https://dbdiagram.io/d/Social-Network-68d6ae16d2b621e422171c3c)

![alt text](scheme.png)

### Прогноз количества дисков для хранения и обработки представленных данных на 1 год:

- [Расчеты RPS/Трафика](https://github.com/zkryaev/social_network_system_design/tree/develop#:~:text=%D0%BA%D0%BE%D0%BC%D0%BC%D0%B5%D0%BD%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F/%D0%BF%D0%BE%D0%B4%D0%BF%D0%B8%D1%81%D0%BA%D0%B8%3A%201%D1%81-,%D0%9E%D1%86%D0%B5%D0%BD%D0%BA%D0%B0%20%D0%BD%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B8,-%D0%A0%D0%B0%D1%81%D1%87%D0%B5%D1%82%20RPS)

#### Расчет характеристик по доменам
| Домен         | Объем хранимого    | Throughput | IOPS    |
|---------------|--------------------|------------|---------|
| Посты         | 3,2 Tb             | 70 Mb/s    | ~3600   |
| Комментарии   | 16 Tb              | 13 Mb/s    | ~1700   |
| Лайки         | 2,2 Tb             | 98 Kb/s    | ~5300   |
| Подписка      | 22 Gb              | 61 Kb/s    | ~600    |
| Профиль       | 31 Mb              | 12 Mb/s    | ~600    |
| Поиск         | —                  | 139 Kb/s   | ~600    |
| Медиа         | 24 Pb (~24 000 Tb) | 53 Gb/s    | ~3600   |


#### Расчет числа HDD по доменам
| Домен         | Объем хранимого | Throughput | IOPS |
|---------------|-----------------|------------|------|
| Посты         | 1               | 1          | 36   |
| Комментарии   | 1               | 1          | 17   |
| Лайки         | 1               | 1          | 53   |
| Подписка      | 1               | 1          | 6    |
| Профиль       | 1               | 1          | 6    |
| Поиск         | —               | 1          | 6    |
| Медиа         | 750             | 530        | 36   |

- Чтобы хранить и обрабатывать в том числе изображения нужно 750 дисков типа HDD
- Если опираться, что средняя цена 6ТБ HDD = 100$, то 750\*(32/6)\*100$ ~ 400k$  

#### Расчет числа SSD по доменам
| Домен         | Объем хранимого | Throughput | IOPS |
|---------------|-----------------|------------|------|
| Посты         | 1               | 1          | 4    |
| Комментарии   | 1               | 1          | 2    |
| Лайки         | 1               | 1          | 6    |
| Подписка      | 1               | 1          | 1    |
| Профиль       | 1               | 1          | 1    |
| Поиск         | —               | 1          | 1    |
| Медиа         | 240             | 106        | 4    |

- Чтобы хранить и обрабатывать в том числе изображения нужно 240 дисков типа SSD
- Если опираться, что средняя цена 6ТБ SSD = 200$, то 240\*(100/6)\*200$ ~ 800k$

#### Расчет числа nVME по доменам
| Домен         | Объем хранимого | Throughput | IOPS |
|---------------|-----------------|------------|------|
| Посты         | 1               | 1          | 1    |
| Комментарии   | 1               | 1          | 1    |
| Лайки         | 1               | 1          | 1    |
| Подписка      | 1               | 1          | 1    |
| Профиль       | 1               | 1          | 1    |
| Поиск         | —               | 1          | 1    |
| Медиа         | 800             | 18         | 1    |

- Чтобы хранить и обрабатывать в том числе изображения нужно 800 дисков типа nVME
- Если опираться, что средняя цена 6ТБ nVME = 500$, то 800\*(30/6)\*500$ ~ 2kk$ 

Вывод:
- В рамках расчетов я бы взял 1 SSD для всех доменов кроме Медиа - его бы хватило на несколько лет.
  
  Медиа держал бы на 750 HDD (какой нибудь Blob Storage развернуть на RAID массивах)

  Таким образом быстро бы грузили ленту, обновляли данные, но с изображениями пришлось бы подождать

- Кроме того, можно подумать о сжатии, правда почти всегда это потери в качестве изображения.


## HW-3.2: Репликация, партиционирование, шардирование, хосты

### Репликация

| Домен        | Стратегия репликации | Replication Factor |
|--------------|----------------------|--------------------|
| Посты        | Master-Slave         | 3                  |
| Комментарии  | Master-Slave         | 3                  |
| Лайки        | Master-Slave         | 3                  |
| Подписка     | Master-Slave         | 3                  |
| Профиль      | Master-Slave         | 3                  |
| Поиск        | —                    | —                  |
| Медиа        | Master-Slave         | 2                  |

Пояснения по доменам:
- Поиск спроектирован поверх существующий логики, поэтому он опущен
- Домены кроме *медиа*, будут по схеме MASTER-SYNC(hot-stanby)-ASYNC(warm-standby), т.к первые два обеспечивают отказоустойчивость, третья реплика больше для вероятной аналитики
- Медиа будет по схеме MASTER-ASYNC(warm-standby), во первых такой объем данных уже очень дорого хранить, заводить 2 реплики кажется ту мач, при этом обеспечиваем надежность хранения и параллелим чтение, т.к трафик большой.

В принципе для всех способ репликации: **Логический - MIXED**

---

### Шардирование:

| Стратегия шардирования | Домены                              |
|------------------------|-------------------------------------|
| Directory Based        | Посты, Профиль                      |
| Key Based              | Лайки, Комментарии, Медиа, Подписка |

```
Кажется, что поскольку люди предпочитают смотреть ленту своей страны/региона по большей части, то для постов и профилей стоит выбрать Directory Based и на основе того же geo_tag_id разбивать на шарды.
Подписки, комментари, лайки и медиа - Key Based относительно post_id, к которым они принадлежат.
```

### Вычисление кол-ва хостов

#### HDD
| Домен        | Кол-во хостов   | С репликацией |
|--------------|-----------------|---------------|
| Посты        | 36 / 2 = 18     | 3 × 18 = 54   |
| Комментарии  | 18              | 54            |
| Лайки        | 18              | 54            |
| Подписка     | 18              | 54            |
| Профиль      | 18              | 54            |
| Медиа        | 750 / 2 = 375   | 2 × 375 = 750 |

#### SSD
| Домен        | Кол-во хостов   | С репликацией |
|--------------|-----------------|---------------|
| Посты        | 1               | 3             |
| Комментарии  | 1               | 3             |
| Лайки        | 1               | 3             |
| Подписка     | 1               | 3             |
| Профиль      | 1               | 3             |
| Поиск        | —               | —             |
| Медиа        | 240 / 2 = 120   | 240           |

#### nVMe
| Домен        | Кол-во хостов   | С репликацией |
|--------------|-----------------|---------------|
| Посты        | 1               | 3             |
| Комментарии  | 1               | 3             |
| Лайки        | 1               | 3             |
| Подписка     | 1               | 3             |
| Профиль      | 1               | 3             |
| Медиа        | 800 / 2 = 400   | 800           |