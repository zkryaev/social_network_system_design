@startuml Geo_container
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
!define DEVICONS https://raw.githubusercontent.com/tupadr3/plantuml-icon-font-sprites/master/devicons

!include DEVICONS/postgresql.puml
!include DEVICONS/redis.puml

Person(client, "Client", "Site/Mobile")
Container(loadBalancer, "Load Balancer", "Nginx", "Uses round robin", $sprite="nginx")
Container(media, "S3 Storage", "Ceph/Minio", "Store images by image_url")
Container(userService, "User Service", "Go", "Store and handle users")
Container(postService, "Post Service", "Go", "Store and handle posts")
Container(reactions, "Reactions Service", "Go", "Store and handle comments and likes")
ContainerQueue(messageQueue, "Events queue", "Kafka", "Message queue for events by post updates")

Container_Boundary(geoServiceGroup, "Geo Service") {
    Container(geoService, "Geo Service", "Go", "Store and handle geo tags", $tags="webApp")
    ContainerDb(geoDB, "Geo database", "PgSQL + PostGIS", "Stores geo tags and metainfo", $tags="db", $sprite="postgresql")
    ContainerDb(geoCache, "Geo cache", "Redis", "Stores popular geo tags", $tags="db", $sprite="redis")
}

Rel(geoService, geoDB, "Read/write geo tags")
Rel(geoService, geoCache, "Cache popular geo tags")

Rel(client, loadBalancer, "Request", "REST")
Rel(loadBalancer, postService, "CRUD post, search", "REST")
Rel(loadBalancer, userService, "CRUD users, subscribes", "REST")
Rel(loadBalancer, reactions, "CRUD likes/comments", "REST")
Rel(loadBalancer, media, "CRUD media", "REST")

Rel(postService, geoService, "Get geo info")
Rel(userService, geoService, "Get geo info")
Rel(postService, messageQueue, "Publishes events for adding/removing a post")
Rel(reactions, messageQueue, "Subscribes on events for adding/removing a post")
Rel(postService, media, "Send updates about post's images")
@enduml