# Cоциальная сеть для путешественников - [System Design Course](https://balun.courses/courses/system_design)

## Функциональные требования
  1. Создание поста, с 1 фотографией, описанием и тэгом местоположения;
  2. Оценка и комментирование поста; 
  3. Подписка на других путешественников, для отслеживание их активности;
  4. Поиск популярных мест для путешествий, выдача постов связанных с этим местом (тэгом местоположения);
  5. Просмотр ленты других путешественников, ленты конкретного пользователя, основанной на подписках в обратном хронологическом порядке;

## Нефункциональные требования
  - **Аудитория**:
    1. **DAU**: *10.000.000*
    2. **Активность пользователя *в среднем***:
        - *Публикует 0,45 постов в день*
        - *Просматривает суммарно 20-30 постов в день из ленты (1 лайк - 1 комментарий):*
          1. Оценивает 5-15 постов (50%)
          2. Комментирует 3-4,5 постов (15%)
          3. Читает 10 комментариев
        - *Подписывается на 0,2 новых путешественника в день*
        - *Смотрит страницу путешественника 5 раз в день*
        - *Выполняет поиск мест для путешествий 3-5 раз в день*
    3. **Регион:** *СНГ*
  - **Особенности приложения**:
    1. **Сезонности в приложении:** *Есть всплески в сезоны отпусков*
    2. **Доступность:** *99.95*
    3. **Условия хранения данных:** *Храним всегда*
    4. **Лимиты и ограничения:**
       1. *Загружать не более 10 постов в день*
       2. *Смотреть, оценивать и комментировать не более 1000 постов в день*
       3. *Оставлять не более 1000 комментариев*
       4. *Размер изображения: <= 2 Мб*
       5. *Текст поста: <= 1000 символов*
       6. *Текст комментария: <= 500 символов*
       7. *Пост содержит: <= 5 изображений*
       8. *Максимальное длина запроса не более 100 символов*
       9. *Максимальное количество подписчиков: <= 100_000*
       10. *Максимальное количество подпис**ок**: <= 10_000*
    5. **Временные ограничения:**
       1. *Создание поста: 3с*
       2. *Получение в ленте 10 постов: 2с*
       4. *Поиск постов: 2с*
       3. *Операция оценки/комментирования/подписки: 1с*

## Оценка нагрузки

### Расчет RPS

DAY = 86400

#### Посты
- RPS(write) = DAU * 0.45 * / DAY = 52
- RPS(read) = DAU * 30 / DAY = 3472

#### Комментарии
- RPS(write) = DAU * 4.5 / DAY = 520

- RPS(read) = DAU * 10 / DAY = 1157

#### Лайки
*Читает лайков столько же сколько посмотрел постов*

- RPS(write) = DAU * 15 / DAY = 1736 

#### Подписка
- RPS = DAU * 0.2 / DAY = 23

#### Просмотр страниц путешественников
- RPS = DAU * 5 / DAY = 579

#### Поиск
- RPS = DAU * 5 / DAY = 579

### Расчет трафика
#### Write

Поскольку в СНГ превалирующее число языков занимает 2 байта в utf-8, поэтому считаю так: число символов * 2 байта

```
CreatePost [~15Mb] {
    id (8)
    user_id (8) 
    text ~ 2Kb (1000 * 2B)
    image[5] ~ 15Mb (5 * 3Mb)
    geo_tag_id (8) // например [Россия, Байкал] = 20141251
    created_at (8)
}

Like [40B] {
    id
    user_id
    post_author_id
    post_id
    created_at
}

Comment [~1Kb] {
    id
    user_id
    author_id
    post_id 
    title  ~ 1Kb (500 * 2B)
    created_at
}

Subcribe [32B] {
    id
    user_id
    target_id
    created_at
}
```
**Результаты трафика Запись:**

`Posts = 52 * 15Mb = 780 Mb/s`

`Comments = 520 * 1Kb = 520 Kb/s`

`Likes = 1736 * 40B = 70 Kb/s`

`Subscribes = 23 * 32B = 736 B/s`

#### Read

```
// Посты получаем пачками до 10 штук
FetchPosts [402Kb*10 = 4020Kb ~4Mb] {
    id
    user_id
    posts: [
        post [~402Kb]: {
            post_id
            author_id
            likes_amount
            geo_tag_id
            created_at
            text ~ 2Kb
            image_url ~ 30B // -> GetImage, если пользователь тыкнет по изображению отдаем уже фулл качество
            image_preview ~ 400Kb // кропнутая версия изображения
        }
        еще 9...
    ]
    cursor
    total
}

GetComments [10Kb] {
    id
    post_id
    comments: [
        "example", ~ 1Kb
        ...
    ]
    cursor
    total
}

GetProfile [~4,5Mb] {
  id
  user_id
  profile_id
  name ~ 50B
  last_name ~ 50B
  profile_img ~ 300Kb
  description ~ 500B
  posts: FetchPosts [4Mb]
}

// Есть список тегов, пользователь вводит условно Байкал и ему выпадает этот тег,
// он его выбирает и получает посты связанные с этим тегом

Search [240B] {
  id
  user_id
  title ~ 200B
  geo_tag_id
  cursor
  total
}

GetImage [~3Mb] {
    image_url ~ 30B
    image ~ 3Mb
}
```
**Результаты трафика Чтение:**

`GetPosts = 3472 * 4Mb ~ 14 Gb/s`

`GetComments = 1157 * 10Kb ~ 12Mb/s`

`GetProfile = 579 * 4.5Mb ~ 2,6 Gb/s`

`Search = 579 * 240B = 139 Kb/s`

- Если отдельно считать еще трафик по изображениям на каждый пост с 5 фото:

`GetImages = 3472 * 5 * 3Mb = 52 Gb/s`

### Расчет одновременных соединений

- Connections = 10 000 000 \* 0.1 = 1 000 000